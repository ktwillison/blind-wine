// C3 init
var jan15 = {"response":{"meta":{"hits":27,"time":310,"offset":0},"docs":[{"word_count":"5498"},{"word_count":"4349"},{"word_count":"355"},{"word_count":"872"},{"word_count":"710"},{"word_count":"382"},{"word_count":"382"},{"word_count":"854"},{"word_count":"224"},{"word_count":"224"}],"facets":{"day_of_week":{"terms":[{"term":"Monday","count":7},{"term":"Saturday","count":7},{"term":"Friday","count":5},{"term":"Sunday","count":3},{"term":"Thursday","count":2}]}}},"status":"OK","copyright":"Copyright (c) 2013 The New York Times Company.  All Rights Reserved."};
var feb15 = {"response":{"meta":{"hits":20,"time":59,"offset":0},"docs":[{"word_count":"1221"},{"word_count":"1574"},{"word_count":"263"},{"word_count":"814"},{"word_count":"815"},{"word_count":"1338"},{"word_count":"824"},{"word_count":"762"},{"word_count":"657"},{"word_count":"472"}],"facets":{"day_of_week":{"terms":[{"term":"Thursday","count":4},{"term":"Monday","count":3},{"term":"Saturday","count":3},{"term":"Sunday","count":3},{"term":"Tuesday","count":3}]}}},"status":"OK","copyright":"Copyright (c) 2013 The New York Times Company.  All Rights Reserved."};
var mar15 = {"response":{"meta":{"hits":27,"time":53,"offset":0},"docs":[{"word_count":"1099"},{"word_count":"413"},{"word_count":"538"},{"word_count":"920"},{"word_count":"862"},{"word_count":"1444"},{"word_count":"217"},{"word_count":"452"},{"word_count":"876"},{"word_count":"790"}],"facets":{"day_of_week":{"terms":[{"term":"Sunday","count":6},{"term":"Wednesday","count":6},{"term":"Monday","count":5},{"term":"Saturday","count":3},{"term":"Tuesday","count":3}]}}},"status":"OK","copyright":"Copyright (c) 2013 The New York Times Company.  All Rights Reserved."};
var apr15 = {"response":{"meta":{"hits":15,"time":77,"offset":0},"docs":[{"word_count":"717"},{"word_count":"716"},{"word_count":"390"},{"word_count":"381"},{"word_count":"1370"},{"word_count":"1128"},{"word_count":"1071"},{"word_count":"1802"},{"word_count":"1573"},{"word_count":"266"}],"facets":{"day_of_week":{"terms":[{"term":"Friday","count":3},{"term":"Sunday","count":3},{"term":"Thursday","count":3},{"term":"Tuesday","count":2},{"term":"Wednesday","count":2}]}}},"status":"OK","copyright":"Copyright (c) 2013 The New York Times Company.  All Rights Reserved."};
var may15 = {"response":{"meta":{"hits":34,"time":52,"offset":0},"docs":[{"word_count":"768"},{"word_count":"1177"},{"word_count":"712"},{"word_count":"946"},{"word_count":"24"},{"word_count":"1048"},{"word_count":"456"},{"word_count":"1068"},{"word_count":"868"},{"word_count":"107"}],"facets":{"day_of_week":{"terms":[{"term":"Monday","count":9},{"term":"Saturday","count":8},{"term":"Thursday","count":7},{"term":"Friday","count":4},{"term":"Sunday","count":3}]}}},"status":"OK","copyright":"Copyright (c) 2013 The New York Times Company.  All Rights Reserved."};
var june15 = {"response":{"meta":{"hits":145,"time":94,"offset":0},"docs":[{"word_count":"1016"},{"word_count":"1427"},{"word_count":"1888"},{"word_count":"952"},{"word_count":"949"},{"word_count":"1624"},{"word_count":"789"},{"word_count":"930"},{"word_count":"1192"},{"word_count":"1430"}],"facets":{"day_of_week":{"terms":[{"term":"Tuesday","count":42},{"term":"Wednesday","count":36},{"term":"Monday","count":22},{"term":"Friday","count":20},{"term":"Thursday","count":11}]}}},"status":"OK","copyright":"Copyright (c) 2013 The New York Times Company.  All Rights Reserved."};
var july15 = {"response":{"meta":{"hits":449,"time":44,"offset":0},"docs":[{"word_count":"1148"},{"word_count":"421"},{"word_count":"584"},{"word_count":"353"},{"word_count":"365"},{"word_count":"520"},{"word_count":"564"},{"word_count":"17"},{"word_count":"228"},{"word_count":"548"}],"facets":{"day_of_week":{"terms":[{"term":"Tuesday","count":82},{"term":"Wednesday","count":80},{"term":"Thursday","count":74},{"term":"Friday","count":59},{"term":"Monday","count":52}]}}},"status":"OK","copyright":"Copyright (c) 2013 The New York Times Company.  All Rights Reserved."};
var aug15 = {"response":{"meta":{"hits":638,"time":50,"offset":0},"docs":[{"word_count":"1787"},{"word_count":"1087"},{"word_count":"437"},{"word_count":"889"},{"word_count":"137"},{"word_count":"737"},{"word_count":"129"},{"word_count":"492"},{"word_count":"30"},{"word_count":"1539"}],"facets":{"day_of_week":{"terms":[{"term":"Tuesday","count":109},{"term":"Friday","count":96},{"term":"Wednesday","count":78},{"term":"Monday","count":75},{"term":"Thursday","count":72}]}}},"status":"OK","copyright":"Copyright (c) 2013 The New York Times Company.  All Rights Reserved."};
var sept15 = {"response":{"meta":{"hits":739,"time":45,"offset":0},"docs":[{"word_count":"1113"},{"word_count":"1362"},{"word_count":"982"},{"word_count":"799"},{"word_count":"909"},{"word_count":"729"},{"word_count":"431"},{"word_count":"241"},{"word_count":"468"},{"word_count":"1137"}],"facets":{"day_of_week":{"terms":[{"term":"Thursday","count":159},{"term":"Tuesday","count":139},{"term":"Wednesday","count":134},{"term":"Friday","count":95},{"term":"Monday","count":63}]}}},"status":"OK","copyright":"Copyright (c) 2013 The New York Times Company.  All Rights Reserved."};
var oct15 = {"response":{"meta":{"hits":529,"time":46,"offset":0},"docs":[{"word_count":"16"},{"word_count":"1933"},{"word_count":"1131"},{"word_count":"848"},{"word_count":"17"},{"word_count":"17"},{"word_count":"392"},{"word_count":"2199"},{"word_count":"1309"},{"word_count":"198"}],"facets":{"day_of_week":{"terms":[{"term":"Thursday","count":100},{"term":"Wednesday","count":86},{"term":"Friday","count":81},{"term":"Tuesday","count":69},{"term":"Monday","count":52}]}}},"status":"OK","copyright":"Copyright (c) 2013 The New York Times Company.  All Rights Reserved."};
var nov15 = {"response":{"meta":{"hits":579,"time":46,"offset":0},"docs":[{"word_count":"1135"},{"word_count":"1330"},{"word_count":"842"},{"word_count":"1055"},{"word_count":"627"},{"word_count":"809"},{"word_count":"344"},{"word_count":"390"},{"word_count":"742"},{"word_count":"441"}],"facets":{"day_of_week":{"terms":[{"term":"Monday","count":101},{"term":"Tuesday","count":98},{"term":"Wednesday","count":80},{"term":"Friday","count":78},{"term":"Sunday","count":59}]}}},"status":"OK","copyright":"Copyright (c) 2013 The New York Times Company.  All Rights Reserved."};
var dec15 = {"response":{"meta":{"hits":915,"time":39,"offset":0},"docs":[{"word_count":"954"},{"word_count":"1237"},{"word_count":"711"},{"word_count":"42"},{"word_count":"1032"},{"word_count":"1060"},{"word_count":"366"},{"word_count":"392"},{"word_count":"311"},{"word_count":"340"}],"facets":{"day_of_week":{"terms":[{"term":"Wednesday","count":213},{"term":"Tuesday","count":195},{"term":"Thursday","count":144},{"term":"Friday","count":117},{"term":"Monday","count":85}]}}},"status":"OK","copyright":"Copyright (c) 2013 The New York Times Company.  All Rights Reserved."};
var jan16 = {"response":{"meta":{"hits":1060,"time":38,"offset":0},"docs":[{"word_count":"1423"},{"word_count":"779"},{"word_count":"132"},{"word_count":"773"},{"word_count":"988"},{"word_count":"487"},{"word_count":"498"},{"word_count":"457"},{"word_count":"417"},{"word_count":"457"}],"facets":{"day_of_week":{"terms":[{"term":"Friday","count":190},{"term":"Monday","count":154},{"term":"Thursday","count":148},{"term":"Tuesday","count":119},{"term":"Wednesday","count":104}]}}},"status":"OK","copyright":"Copyright (c) 2013 The New York Times Company.  All Rights Reserved."}; 
var feb16 = {"response":{"meta":{"hits":1282,"time":34,"offset":0},"docs":[{"word_count":"870"},{"word_count":"1577"},{"word_count":"1108"},{"word_count":"530"},{"word_count":"1035"},{"word_count":"566"},{"word_count":"712"},{"word_count":"1460"},{"word_count":"1178"},{"word_count":"1384"}],"facets":{"day_of_week":{"terms":[{"term":"Tuesday","count":240},{"term":"Monday","count":209},{"term":"Wednesday","count":147},{"term":"Friday","count":141},{"term":"Thursday","count":134}]}}},"status":"OK","copyright":"Copyright (c) 2013 The New York Times Company.  All Rights Reserved."};
var mar16 = {"response":{"meta":{"hits":1698,"time":27,"offset":0},"docs":[{"word_count":"1025"},{"word_count":"1646"},{"word_count":"862"},{"word_count":"1375"},{"word_count":"1110"},{"word_count":"1222"},{"word_count":"520"},{"word_count":"533"},{"word_count":"1077"},{"word_count":"913"}],"facets":{"day_of_week":{"terms":[{"term":"Wednesday","count":320},{"term":"Tuesday","count":314},{"term":"Thursday","count":311},{"term":"Friday","count":258},{"term":"Monday","count":145}]}}},"status":"OK","copyright":"Copyright (c) 2013 The New York Times Company.  All Rights Reserved."};


var data = [jan15, feb15, mar15, apr15, may15, june15, july15, aug15, sept15, oct15, nov15, dec15, jan16, feb16, mar16];
var months = ["January", "Febuary", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"]

for(i=0; i<data.length; i++) {
  var cleaned_data = {
    "month" : i % 12 + 1,
    "monthName" : months[i % 12],
    "year" : 2015+ Math.floor(i / 12),
    "Total Article Count" : data[i].response.meta.hits,
    "Monday": 0,
    "Tuesday": 0,
    "Wednesday": 0,
    "Thursday": 0,
    "Friday": 0,
    "Saturday": 0,
    "Sunday": 0,
  }
  cleaned_data.date = new Date(cleaned_data.year + '-' + cleaned_data.month + '-15');

  data[i].response.facets.day_of_week.terms.forEach(function(f) {
    cleaned_data[f.term] = f.count;
  });

  data[i] = cleaned_data;
}

var events = [{"date": "2015-06-06", "name": "June 6th, 2015: Donald announces his candidacy"},
  {"date": "2015-08-06", "name": "August 6th: The candidates participate in the Fox News debate, where Donald gets in a tiff with Megan Kelly (which continues over twitter for the next few weeks)"},
  {"date": "2015-12-07", "name": "December 7th: Donald suggests a ‘total and complete shutdown on Muslims entering the United States’"},
  {"date": "2015-12-09", "name": "Two days later, CREDO launches a petition for CNN and MSNBC to stop excessively covering Trump, receiving 200k+ signatures"},
  {"date": "2016-01-26", "name": "Clearly, this petition has little effect on the New York Times coverage of Trump. On January 26th, 2016, Trump skips Fox’s GOP debate, generating even more headlines."},
  {"date": "2016-02-20", "name": "On Febuary 20th, Bush suspends his presidential campaign, focusing media attention on Trump, Cruz and Rubio."},
  {"date": "2016-02-28", "name": "Febuary 28th: Trump claims ignorance re: David Duke (and his support), creating yet another media storm."},
  {"date": "2016-03-03", "name": "At the beginning of March, Romney begins to heavily criticize Trump in an effort to unify the party against him."},
  {"date": "2016-03-10", "name": "On March 10th, a protester is sucker-punched at a Trump rally, generating a conversation re: violence at rallies."},
  ]


var event_regions = {
  regions: [],
  descriptions: []
}
for(i=0; i<events.length; i++) {
  event_regions.descriptions.push(events[i].name);
  var date_start = new Date(events[i].date);
  var date_end = new Date(events[i].date);
  date_end = new Date(date_end.setDate(date_start.getDate() + 2));
  event_regions.regions.push({
    "end": date_end,
    "start": date_start,
  });
}

var my_chart_parameters = {
  "bindto": '#donald_chart',
  "data": {
    'json': data,
    'keys': {
      'x': 'date',
      'value': ['Total Article Count']
    },
    "selection": {
      "enabled": true
    }
  },
  "axis": {
    "x": {
      "type": 'timeseries',
      "tick": {
        "format": "%b '%y"
      }
    }
  },
  "type": 'timeseries',
  "point": {
    "focus": {
      "expand": {
        "r": 7,
        "enabled": true
      }
    }
  },
  "grid": {
    "x": {
      "show": false
    },
    "y": {
      "show": true
    }
  },
  "tooltip": {
    "show": true,
    "grouped": false
  }
};

var my_chart_object = c3.generate(my_chart_parameters);


// slides
var slide_0 = function() {
  my_chart_object.transform("line");
  document.getElementById("donald_message").innerHTML = "An examination of the volume of NYT articles about The Donald over time (obtained via the New York Times Article Search API V2).";
};

var slide_1 = function() {
  my_chart_object.regions(event_regions.regions);
  document.getElementById("donald_message").innerHTML = "Let's have a look at some of the events that may have affected Trump's media coverage over the last year or so:";
};

var selected_region = -1;
function selectNextRegion() {  

  my_chart_object.regions.remove({classes: ['selected_region']});      
  selected_region += 1;

  if(selected_region>0){
    event_regions.regions[selected_region-1].class = null;
    event_regions.regions[selected_region-1].opacity = null;
  }

  event_regions.regions[selected_region].class = 'selected_region';
  event_regions.regions[selected_region].opacity = 0.55;
  
  document.getElementById("donald_message").innerHTML = event_regions.descriptions[selected_region];
  my_chart_object.regions(event_regions.regions);
}

var slide_2 = function() { selectNextRegion(); }
var slide_3 = function() { selectNextRegion(); }
var slide_4 = function() { selectNextRegion(); }
var slide_5 = function() { selectNextRegion(); }
var slide_6 = function() { selectNextRegion(); }
var slide_7 = function() { selectNextRegion(); }
var slide_8 = function() { selectNextRegion(); }
var slide_9 = function() { selectNextRegion(); }
var slide_10 = function() { selectNextRegion(); }

var slide_11 = function() {
  my_chart_object.regions([]);
  document.getElementById("donald_message").innerHTML = "Now, let's have a look at NYT coverage of Trump broken down by day of the week (because we can!).";
};


var slide_12 = function() {
  my_chart_object.load({
    'json': data,
    'keys': {
      'x': 'date',
      'value': ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"]
    },
  });

  my_chart_object.data.colors({
    "Monday": '#1f77b4',
    "Tuesday": '#aec7e8',
    "Wednesday": '#ff7f0e',
    "Thursday": '#ffbb78',
    "Friday": '#2ca02c',
    "Saturday": '#98df8a',
    "Sunday": '#d62728',
  });

  my_chart_object.transform("bar");
  document.getElementById("donald_message").innerHTML = "Here we see the relative share of headline published in each day of the week.";
};

var slide_13 = function() {
  my_chart_object.groups([["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"]]);
  document.getElementById("donald_message").innerHTML = "Alas, stacking the data, we see that the NYT API might have lied to us about those numbers. It seems unlikely that there were no articles published about Trump over the weekends of early 2016!";
};

var slide_14 = function() {
  my_chart_object.unload({
    ids: ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"]
  });

  document.getElementById("donald_message").innerHTML = "Nevertheless, it looks as though media coverage about Trump from the NYT is still on an upward trajectory, despite a temporary slump in the fall of 2015. Oh what an entertaining spring it will likely be!\n\nWant to see this again?";
};


var slides = [slide_0, slide_1, slide_2, slide_3, slide_4, slide_5, slide_6, slide_7, slide_8, slide_9, slide_10, slide_11, slide_12, slide_13, slide_14];

// cycle through slides

var current_slide = 0;

var run = function() {
  slides[current_slide]();
  current_slide += 1;

  if (current_slide === 1) {
    document.getElementById("start_btn").innerHTML = "Start";
  } else if (current_slide === slides.length) {
    current_slide = 0;
    selected_region = -1;
    document.getElementById("start_btn").innerHTML = "Replay";
  } else {
    document.getElementById("start_btn").innerHTML = "Continue";
  }
};

// button event handler

document.getElementById('start_btn').addEventListener("click", run);

// init

run();